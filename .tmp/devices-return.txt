    try {
      await navigator.clipboard.writeText(value);
      addToast(`${label} nusxalandi`, 'success');
    } catch (error: unknown) {
      void error;
      addToast('Nusxalashda xato', 'error');
    }
  };

  return (
    <div className="page">
      <div className="page-header">
        <div>
          <h1 className="page-title">Qurilmalar</h1>
          <p className="page-description">Hikvision qurilmalarini boshqarish</p>
        </div>
        <div className="page-actions">
          <button
            className="button button-primary"
            onClick={openCreateModal}
          >
            <Icons.Plus /> Qurilma qo'shish
          </button>
        </div>
      </div>

      <div className="page-content">
        <div className="two-column-layout">
          {/* Webhook */}
          <div className="card">
            <h2>Webhook manzillari</h2>
            {webhookLoading && <p className="notice">Yuklanmoqda...</p>}
            {!webhookLoading && !webhookInfo && (
              <p className="notice notice-warning">Webhook ma'lumotlari topilmadi</p>
            )}
            {webhookInfo && (
              <div className="webhook-panel">
                <div className="webhook-field">
                  <label>Kirish webhooki (Hikvision URL)</label>
                  <div className="webhook-row">
                    <input
                      className="input webhook-input"
                      readOnly
                      value={showWebhookAdvanced
                        ? formatWebhookUrl(webhookInfo.inUrlWithSecret)
                        : maskWebhookValue(formatWebhookUrl(webhookInfo.inUrlWithSecret), 'url')}
                    />
                    <button
                      type="button"
                      className="btn-icon"
                      onClick={() => setShowWebhookAdvanced((v) => !v)}
                      title={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                      aria-label={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                    >
                      {showWebhookAdvanced ? <Icons.EyeOff /> : <Icons.Eye />}
                    </button>
                    <button
                      type="button"
                      className="btn-icon btn-primary"
                      onClick={() => copyToClipboard(formatWebhookUrl(webhookInfo.inUrlWithSecret), 'Kirish webhooki')}
                      title="Nusxalash"
                      aria-label="Nusxalash"
                    >
                      <Icons.Copy />
                    </button>
                  </div>
                </div>

                <div className="webhook-field">
                  <label>Chiqish webhooki (Hikvision URL)</label>
                  <div className="webhook-row">
                    <input
                      className="input webhook-input"
                      readOnly
                      value={showWebhookAdvanced
                        ? formatWebhookUrl(webhookInfo.outUrlWithSecret)
                        : maskWebhookValue(formatWebhookUrl(webhookInfo.outUrlWithSecret), 'url')}
                    />
                    <button
                      type="button"
                      className="btn-icon"
                      onClick={() => setShowWebhookAdvanced((v) => !v)}
                      title={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                      aria-label={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                    >
                      {showWebhookAdvanced ? <Icons.EyeOff /> : <Icons.Eye />}
                    </button>
                    <button
                      type="button"
                      className="btn-icon btn-primary"
                      onClick={() => copyToClipboard(formatWebhookUrl(webhookInfo.outUrlWithSecret), 'Chiqish webhooki')}
                      title="Nusxalash"
                      aria-label="Nusxalash"
                    >
                      <Icons.Copy />
                    </button>
                  </div>
                </div>

                <div className="webhook-advanced">
                  <div className="webhook-advanced-header">
                    <span>Advanced (header orqali yuborish)</span>
                    <button
                      type="button"
                      className="btn-icon"
                      onClick={() => setShowWebhookAdvanced((v) => !v)}
                      title={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                      aria-label={showWebhookAdvanced ? 'Yashirish' : "Ko'rsatish"}
                    >
                      {showWebhookAdvanced ? <Icons.EyeOff /> : <Icons.Eye />}
                    </button>
                  </div>
                  {showWebhookAdvanced && (
                    <div className="webhook-advanced-body">
                      <div className="webhook-field">
                        <label>Header nomi (key)</label>
                        <div className="webhook-row">
                          <input
                            className="input webhook-input"
                            readOnly
                            value={webhookInfo.secretHeaderName}
                          />
                          <button
                            type="button"
                            className="btn-icon btn-primary"
                            onClick={() => copyToClipboard(webhookInfo.secretHeaderName, 'Header nomi')}
                            title="Nusxalash"
                            aria-label="Nusxalash"
                          >
                            <Icons.Copy />
                          </button>
                        </div>
                      </div>
                      <div className="webhook-field">
                        <label>Kirish secret</label>
                        <div className="webhook-row">
                          <input
                            className="input webhook-input"
                            readOnly
                            value={webhookInfo.inSecret}
                          />
                          <button
                            type="button"
                            className="btn-icon btn-primary"
                            onClick={() => copyToClipboard(webhookInfo.inSecret, 'Kirish secret')}
                            title="Nusxalash"
                            aria-label="Nusxalash"
                          >
                            <Icons.Copy />
                          </button>
                        </div>
                      </div>
                      <div className="webhook-field">
                        <label>Chiqish secret</label>
                        <div className="webhook-row">
                          <input
                            className="input webhook-input"
                            readOnly
                            value={webhookInfo.outSecret}
                          />
                          <button
                            type="button"
                            className="btn-icon btn-primary"
                            onClick={() => copyToClipboard(webhookInfo.outSecret, 'Chiqish secret')}
                            title="Nusxalash"
                            aria-label="Nusxalash"
                          >
                            <Icons.Copy />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                <div className="webhook-note">
                  <div>Webhook endpointlar faqat path ko'rinishida beriladi.</div>
                  <div>Port: <strong>{getBackendPortLabel() || 'Noma\'lum'}</strong></div>
                </div>
              </div>
            )}
          </div>

          {/* Device List */}
          <div className="card">
            <div className="panel-header">
              <div>
                <div className="panel-title">Qurilmalar ro'yxati</div>
                <div className="panel-subtitle">
                  Tizimdagi qurilmalar ro'yxati
                </div>
              </div>
              <div className="panel-actions">
                <button
                  type="button"
                  className="btn-icon"
                  onClick={loadBackendDevices}
                  disabled={backendLoading}
                  title="Yangilash" aria-label="Yangilash"
                >
                  <Icons.Refresh />
                </button>
              </div>
            </div>
            {backendDevices.length === 0 ? (
              <div className="empty-state">
                <Icons.Monitor />
                <p>Qurilmalar yo'q</p>
              </div>
            ) : (
              <div className="device-list">
                {backendDevices.map((backend) => {
                  const local = getCredentialsForBackend(backend);
                  const credentialsExpired = isCredentialsExpired(local);
                  const credentialsState = local
                    ? credentialsExpired
                      ? 'expired'
                      : 'ok'
                    : 'missing';
                  const backendOnline = isBackendOnline(backend.lastSeenAt || undefined);
                  const testState = testStatus[backend.id];
                  return (
                    <div key={backend.id} className="device-item">
                      <div className="device-item-header">
                        <strong>{backend.name}</strong>
                        <div className="device-item-meta">
                          {backend.deviceId && <span className="badge">ID: {backend.deviceId}</span>}
                          {backend.type && (
                            <span className="badge">{backend.type === 'ENTRANCE' ? 'Kirish' : 'Chiqish'}</span>
                          )}
                          {backend.location && <span className="badge">{backend.location}</span>}
                          {backend.isActive === false && (
                            <span className="badge badge-warning">Nofaol</span>
                          )}
                          {backend.lastSeenAt && (
                            <span className="badge">
                              Oxirgi: {new Date(backend.lastSeenAt).toLocaleString()}
                            </span>
                          )}
                          <span className={`badge ${backendOnline ? 'badge-success' : 'badge-danger'}`}>
                            {backendOnline ? 'Online' : 'Offline'}
                          </span>
                          {credentialsState === 'ok' && (
                            <span className="badge badge-success">Ulanish sozlangan</span>
                          )}
                          {credentialsState === 'expired' && (
                            <span className="badge badge-warning">Ulanish muddati tugagan</span>
                          )}
                          {credentialsState === 'missing' && (
                            <span className="badge badge-warning">Ulanish sozlanmagan</span>
                          )}
                          {testState === 'ok' && (
                            <span className="badge badge-success">Test: OK</span>
                          )}
                          {testState === 'fail' && (
                            <span className="badge badge-danger">Test: Xato</span>
                          )}
                        </div>
                      </div>
                      <div className="device-item-actions">
                        <button
                          className="btn-icon"
                          onClick={() => navigate(`/devices/${backend.id}`)}
                          title="Detail"
                          aria-label="Detail"
                        >
                          <Icons.Eye />
                        </button>
                        <button
                          className="btn-icon"
                          onClick={() => handleTestConnection(backend)}
                          title="Ulanishni tekshirish"
                          aria-label="Ulanishni tekshirish"
                          disabled={testingId === backend.id}
                        >
                          {testingId === backend.id ? <span className="spinner" /> : <Icons.Refresh />}
                        </button>
                        <button
                          className="btn-icon"
                          onClick={() => openCredentialsModal(backend)}
                          title="Ulanish sozlamalari"
                          aria-label="Ulanish sozlamalari"
                        >
                          <Icons.Link />
                        </button>
                        <button
                          className="btn-icon btn-primary"
                          onClick={() => openEditModal(backend)}
                          title="Tahrirlash"
                          aria-label="Tahrirlash"
                        >
                          <Icons.Edit />
                        </button>
                        <button
                          className="btn-icon"
                          onClick={() => setPendingClone(backend)}
                          title="Clone (barcha o'quvchilarni yuklash)"
                          aria-label="Clone (barcha o'quvchilarni yuklash)"
                        >
                          <Icons.Download />
                        </button>
                        <button
                          className="btn-icon"
                          onClick={() => {
                            setPendingDeviceClone(backend);
                            setSourceCloneId('');
                            setDeviceCloneStatus(null);
                          }}
                          title="Clone (qurilmadan qurilmaga)"
                          aria-label="Clone (qurilmadan qurilmaga)"
                        >
                          <Icons.Copy />
                        </button>
                        <button
                          className="btn-icon btn-danger"
                          onClick={() => setPendingDelete(backend)}
                          title="O'chirish"
                          aria-label="O'chirish"
                        >
                          <Icons.Trash />
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

        </div>
      </div>

      {isModalOpen && (
        <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
          <div
            ref={modalDialogRef}
            className="modal"
            onClick={(e) => e.stopPropagation()}
            onKeyDown={onModalDialogKeyDown}
            role="dialog"
            aria-modal="true"
            aria-label={editingBackendId ? "Qurilmani tahrirlash" : "Yangi qurilma"}
            tabIndex={-1}
          >
            <div className="modal-header">
              <h3>{editingBackendId ? 'Qurilmani tahrirlash' : 'Yangi qurilma'}</h3>
              <button className="modal-close" onClick={() => setIsModalOpen(false)} aria-label="Yopish">
                <Icons.X />
              </button>
            </div>
            <div className="modal-body">
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label>Nomi *</label>
                  <input
                    className="input"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    placeholder="Asosiy kirish"
                    autoFocus
                    required
                  />
                </div>

                <div className="form-group">
                  <label>Joylashuv</label>
                  <input
                    className="input"
                    value={formData.location}
                    onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                    placeholder="Masalan: 1-qavat, asosiy kirish"
                  />
                </div>

                <div className="form-group">
                  <label>Device ID (Hikvision)</label>
                  <input
                    className="input"
                    value={formData.deviceId}
                    onChange={(e) => setFormData({ ...formData, deviceId: e.target.value })}
                    placeholder="Bo'sh qoldirsangiz ulanishdan keyin avtomatik olinadi"
                  />
                </div>

                <div className="form-group">
                  <label>Turi</label>
                  <select
                    className="input"
                    value={formData.deviceType}
                    onChange={(e) => setFormData({ ...formData, deviceType: e.target.value })}
                  >
                    <option value="ENTRANCE">Kirish</option>
                    <option value="EXIT">Chiqish</option>
                  </select>
                </div>

                <div className="form-group">
                  <label>IP manzil (ixtiyoriy, auto detect uchun)</label>
                  <input
                    className="input"
                    value={formData.host}
                    onChange={(e) => setFormData({ ...formData, host: e.target.value })}
                    placeholder="192.168.1.100"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label>Port</label>
                    <input
                      className="input"
                      type="number"
                      value={formData.port}
                      onChange={(e) => setFormData({ ...formData, port: Number(e.target.value) })}
                    />
                  </div>
                  <div className="form-group">
                    <label>Username (ixtiyoriy)</label>
                    <input
                      className="input"
                      value={formData.username}
                      onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Parol (ixtiyoriy)</label>
                  <input
                    className="input"
                    type="password"
                    value={formData.password}
                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                  />
                </div>

                <p className="notice">
                  Agar `deviceId` kiritilmasa va ulanish ma'lumotlari berilsa, tizim qurilmadan `deviceId` ni avtomatik topadi.
                </p>

                <div className="form-actions">
                  <button
                    type="submit"
                    className="button button-primary"
                    disabled={loading}
                  >
                    {editingBackendId ? <><Icons.Edit /> Saqlash</> : <><Icons.Plus /> Qo'shish</>}
                  </button>
                  <button
                    type="button"
                    className="button button-secondary"
                    onClick={() => setIsModalOpen(false)}
                  >
                    <Icons.X /> Bekor qilish
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {isCredentialsModalOpen && (
        <div className="modal-overlay" onClick={() => setIsCredentialsModalOpen(false)}>
          <div
            ref={credentialsDialogRef}
            className="modal"
            onClick={(e) => e.stopPropagation()}
            onKeyDown={onCredentialsDialogKeyDown}
            role="dialog"
            aria-modal="true"
            aria-label="Ulanish sozlamalari"
            tabIndex={-1}
          >
            <div className="modal-header">
              <h3>Ulanish sozlamalari</h3>
              <button className="modal-close" onClick={() => setIsCredentialsModalOpen(false)} aria-label="Yopish">
                <Icons.X />
              </button>
            </div>
            <div className="modal-body">
              <form onSubmit={handleSubmit}>
                <div className="form-row">
                  <div className="form-group">
                    <label>IP manzil</label>
                    <input
                      className="input"
                      value={formData.host}
                      onChange={(e) => setFormData({ ...formData, host: e.target.value })}
                      placeholder="192.168.1.100"
                      autoFocus
                    />
                  </div>
                  <div className="form-group">
                    <label>Port</label>
                    <input
                      className="input"
                      type="number"
                      value={formData.port}
                      onChange={(e) => setFormData({ ...formData, port: Number(e.target.value) })}
                    />
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label>Username</label>
                    <input
                      className="input"
                      value={formData.username}
                      onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                    />
                  </div>
                  <div className="form-group">
                    <label>Parol</label>
                    <input
                      className="input"
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                    />
                  </div>
                </div>

                <p className="notice">
                  Login va parol backendga yuborilmaydi. Faqat shu kompyuterda saqlanadi va 30 kun amal qiladi.
                </p>

                <div className="form-actions">
                  <button
                    type="submit"
                    className="button button-primary"
                    disabled={loading}
                  >
                    <><Icons.Edit /> Saqlash</>
                  </button>
                  <button
                    type="button"
                    className="button button-secondary"
                    onClick={() => setIsCredentialsModalOpen(false)}
                  >
                    <Icons.X /> Bekor qilish
                  </button>
                </div>

                {deviceLimitReached && !editingLocalId && (
                  <p className="notice notice-warning">
                    Ulanish sozlamalari limiti {DEVICE_CREDENTIALS_LIMIT} ta. Yangi login/parol qo'shishda limit tekshiriladi.
                  </p>
                )}
              </form>
            </div>
          </div>
        </div>
      )}

      {pendingDelete && (
        <div className="modal-overlay" onClick={() => setPendingDelete(null)}>
          <div
            ref={deleteDialogRef}
            className="modal"
            onClick={(e) => e.stopPropagation()}
            onKeyDown={onDeleteDialogKeyDown}
            role="dialog"
            aria-modal="true"
            aria-label="Qurilmani o'chirish"
            tabIndex={-1}
          >
            <div className="modal-header">
              <h3>Qurilmani o'chirish</h3>
              <button className="modal-close" onClick={() => setPendingDelete(null)} aria-label="Yopish">
                <Icons.X />
              </button>
            </div>
            <div className="modal-body">
              <p className="notice notice-warning">
                <strong>{pendingDelete.name}</strong> qurilmasi o'chiriladi. Davom etasizmi?
              </p>
              <div className="form-actions">
                <button
                  type="button"
                  className="button button-danger"
                  onClick={handleDeleteDevice}
                  disabled={loading}
                >
                  <Icons.Trash /> O'chirish
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => setPendingDelete(null)}
                  disabled={loading}
                >
                  <Icons.X /> Bekor qilish
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {pendingClone && (
        <div className="modal-overlay" onClick={() => !cloneStatus?.running && setPendingClone(null)}>
          <div
            ref={cloneDialogRef}
            className="modal"
            onClick={(e) => e.stopPropagation()}
            onKeyDown={onCloneDialogKeyDown}
            role="dialog"
            aria-modal="true"
            aria-label="Clone mode"
            tabIndex={-1}
          >
            <div className="modal-header">
              <h3>Clone mode</h3>
              <button
                className="modal-close"
                onClick={() => !cloneStatus?.running && setPendingClone(null)}
                disabled={cloneStatus?.running}
                aria-label="Yopish"
              >
                <Icons.X />
              </button>
            </div>
            <div className="modal-body">
              <p className="notice notice-warning">
                <strong>{pendingClone.name}</strong> qurilmasiga bazadagi barcha o'quvchilar yuboriladi.
              </p>

              {cloneStatus && (
                <div className="notice">
                  <div>Jami: {cloneStatus.processed}</div>
                  <div>Muvaffaqiyatli: {cloneStatus.success}</div>
                  <div>Xato: {cloneStatus.failed}</div>
                  <div>O'tkazildi: {cloneStatus.skipped}</div>
                </div>
              )}

              {cloneStatus?.errors?.length ? (
                <div className="notice notice-error" style={{ maxHeight: 200, overflow: 'auto' }}>
                  {cloneStatus.errors.slice(0, 20).map((item, idx) => (
                    <div key={`${item.studentId || 'x'}-${idx}`}>
                      {(item.name || item.studentId || 'Student')}: {item.reason || "Xato"}
                    </div>
                  ))}
                </div>
              ) : null}

              <div className="form-actions">
                <button
                  type="button"
                  className="button button-primary"
                  onClick={handleStartClone}
                  disabled={cloneStatus?.running}
                >
                  <Icons.Download /> {cloneStatus?.running ? 'Yuklanmoqda...' : 'Boshlash'}
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => setPendingClone(null)}
                  disabled={cloneStatus?.running}
                >
                  <Icons.X /> Yopish
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {pendingDeviceClone && (
        <div className="modal-overlay" onClick={() => !deviceCloneStatus?.running && setPendingDeviceClone(null)}>
          <div
            ref={deviceCloneDialogRef}
            className="modal"
            onClick={(e) => e.stopPropagation()}
            onKeyDown={onDeviceCloneDialogKeyDown}
            role="dialog"
            aria-modal="true"
            aria-label="Qurilmadan qurilmaga clone"
            tabIndex={-1}
          >
            <div className="modal-header">
              <h3>Qurilmadan qurilmaga clone</h3>
              <button
                className="modal-close"
                onClick={() => !deviceCloneStatus?.running && setPendingDeviceClone(null)}
                disabled={deviceCloneStatus?.running}
                aria-label="Yopish"
              >
                <Icons.X />
              </button>
            </div>
            <div className="modal-body">
              <p className="notice notice-warning">
                <strong>{pendingDeviceClone.name}</strong> qurilmasiga boshqa qurilmadagi o'quvchilar ko'chiriladi.
              </p>

              <div className="form-group">
                <label>Manba qurilma</label>
                <select
                  className="input"
                  value={sourceCloneId}
                  onChange={(e) => setSourceCloneId(e.target.value)}
                  disabled={deviceCloneStatus?.running}
                >
                  <option value="">Tanlang</option>
                  {backendDevices
                    .filter((d) => d.id !== pendingDeviceClone.id)
                    .map((d) => (
                      <option key={d.id} value={d.id}>{d.name}</option>
                    ))}
                </select>
              </div>

              {deviceCloneStatus && (
                <div className="notice">
                  <div>Jami: {deviceCloneStatus.processed}</div>
                  <div>Muvaffaqiyatli: {deviceCloneStatus.success}</div>
                  <div>Xato: {deviceCloneStatus.failed}</div>
                  <div>O'tkazildi: {deviceCloneStatus.skipped}</div>
                </div>
              )}

              {deviceCloneStatus?.errors?.length ? (
                <div className="notice notice-error" style={{ maxHeight: 200, overflow: 'auto' }}>
                  {deviceCloneStatus.errors.slice(0, 20).map((item, idx) => (
                    <div key={`${item.employeeNo || 'x'}-${idx}`}>
                      {(item.name || item.employeeNo || 'Student')}: {item.reason || "Xato"}
                    </div>
                  ))}
                </div>
              ) : null}

              <div className="form-actions">
                <button
                  type="button"
                  className="button button-primary"
                  onClick={handleStartDeviceClone}
                  disabled={deviceCloneStatus?.running || !sourceCloneId}
                >
                  <Icons.Download /> {deviceCloneStatus?.running ? 'Yuklanmoqda...' : 'Boshlash'}
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => setPendingDeviceClone(null)}
                  disabled={deviceCloneStatus?.running}
                >
                  <Icons.X /> Yopish
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
